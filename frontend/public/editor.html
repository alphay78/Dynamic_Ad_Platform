<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Generator (Merged)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="templates.js"></script> 
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ADD THIS CSS to prevent overflow */
        html, body, .flex-col {
            overflow: hidden; 
            /* This line is often necessary to stop scrollbars */
        }
        .flex-col {
             height: 100vh; /* Ensure the top container fills the screen */
        }
        
        #canvas-container {
            /* Max size of the viewing window */
            max-width: 800px; 
            max-height: 800px; 
            
            /* Define the *logical* size which will be scaled by JS */
            width: 1080px; 
            height: 1080px; 

            transform-origin: center center;
            transition: transform 0.2s ease, width 0.2s ease, height 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }
        
        input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            border: 1px solid #d1d5db; width: 100%; height: 40px;
            padding: 0; cursor: pointer; border-radius: 6px;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 4px; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 m-0 font-sans">

    <input type="file" id="templateFileInput" accept=".json" class="hidden">

    <div class="flex flex-col h-screen">

        <header class="bg-white p-4 shadow-md flex items-center justify-between z-10">
            <h1 class="text-xl font-bold text-gray-800">Ad Generator</h1>
            <div class="flex gap-4 items-center">
               
                <div class="flex items-center space-x-2">
                    <label class="block text-sm font-medium text-gray-700">Zoom: <span id="zoomValue" class="font-bold text-indigo-600">64%</span></label>
                    <button id="zoom-out" title="Zoom out" class="text-md bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300 transition">-</button>
                    <input type="range" id="zoomSlider" min="25" max="200" class="w-32 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <button id="zoom-in" title="Zoom in" class="text-md bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300 transition">+</button>
                    <button id="zoom-reset" class="text-sm bg-gray-500 text-white py-1 px-3 rounded-lg hover:bg-gray-600 transition shadow-sm">Reset</button>
                </div>

                <button id="export-png-btn" class="bg-green-500 text-white font-bold py-2 px-5 text-lg rounded-lg shadow hover:bg-green-600 transition">
                    Export as PNG
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            
            <aside class="w-80 bg-white p-4 overflow-y-auto shadow-lg space-y-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Tools</h2>

                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Canvas BG Color:</label>
                    <input type="color" id="bg-color-picker" class="w-full" value="#fcfcfc">
                </div>
                
                <hr>

                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Add Elements</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="add-title-btn" class="text-sm bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 transition shadow-sm">Title</button>
                        <button id="add-subtitle-btn" class="text-sm bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition shadow-sm">Subtitle</button>
                        <button id="add-button-btn" class="text-sm bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition shadow-sm">Button</button>
                    </div>
                </div>

                <hr>

                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Add Image</h3>
                    <label for="add-image-input" class="w-full text-center bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition cursor-pointer block">
                        Add from File
                        <input type="file" id="add-image-input" class="hidden" accept="image/*">
                    </label>
                    <div class="flex space-x-2 mt-2">
                        <input type="text" id="image-url-input" class="w-full border border-gray-300 p-2 text-sm rounded-lg" placeholder="Or paste image URL...">
                        <button id="add-image-url-btn" class="bg-blue-500 text-white text-sm px-3 rounded-lg hover:bg-blue-600 transition">Add</button>
                    </div>
                </div>

                <hr>
                
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Layer Controls</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="move-to-front-btn" class="text-sm bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition">Bring to Front</button>
                        <button id="send-to-back-btn" class="text-sm bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition">Send to Back</button>
                        <button id="move-forward-btn" class="text-sm bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition">Bring Forward</button>
                        <button id="send-backward-btn" class="text-sm bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition">Send Backward</button>

                        <button id="lock-selected-btn" class="text-sm bg-yellow-500 text-black py-2 px-4 rounded-lg hover:bg-yellow-600 transition">üîí Lock Selected</button>
                        <button id="unlock-all-btn" class="text-sm bg-yellow-300 text-black py-2 px-4 rounded-lg hover:bg-yellow-400 transition">üîì Unlock All</button>
                    </div>
                </div>

                <hr>

                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Project</h3>
                    <div class="space-y-2">
                         <button id="export-template-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition text-sm shadow-md">üíæ Export Template (.json)</button>
                         <button id="import-template-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm shadow-md">üìÅ Import Template (.json)</button>
                    </div>
                </div>

                <hr>

                <button id="delete-btn" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition">
                    üóëÔ∏è Delete Selected
                </button>
                

                <div id="text-controls" class="hidden mt-6 space-y-3">
                    <hr>
                    <h3 class="font-semibold text-gray-700">Text Controls:</h3>
                    
                    <label class="block text-sm font-medium text-gray-700">Font:</label>
                    <select id="font-family-select" class="w-full border border-gray-300 rounded-lg p-2"></select>

                    <label class="block text-sm font-medium text-gray-700">Font Size:</label>
                    <input type="number" id="font-size-input" min="10" max="300" class="w-full border border-gray-300 rounded-lg p-2">

                    <label class="block text-sm font-medium text-gray-700">Text Color:</label>
                    <input type="color" id="text-color-picker" class="w-full" value="#000000">
                </div>
                
                <div id="button-controls" class="hidden mt-6 space-y-3">
                    <hr>
                    <h3 class="font-semibold text-gray-700">Button Controls:</h3>
                    
                    <label class="block text-sm font-medium text-gray-700">Button BG Color:</label>
                    <input type="color" id="button-color-picker" class="w-full" value="#fcd34d">
                </div>
                
            </aside>

            <main class="flex-1 px-8 py-8 bg-gray-100 flex items-center justify-center overflow-auto">
                <div class="canvas-wrapper mb-48">
                    <div id="canvas-container">
                        <canvas id="my-canvas"></canvas>
                    </div>
                </div>
            </main>

            <aside id="variants-sidebar" class="w-60 bg-white p-4 overflow-y-auto shadow-lg space-y-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Template Variants</h2>
                <div id="variants-list" class="space-y-3">
                    <p class="text-sm text-gray-500 italic" id="variants-placeholder">No template loaded.</p>
                </div>
            </aside>

        </div>
    </div>


    <script>
        // --- Wait for the page to be ready ---
        window.addEventListener('load', () => {
            
            // --- Initialize Canvas ---

            //fabric.Object.ownProperties.push('name', 'isButton', 'isButtonText', 'isButtonRect');

            const canvas = new fabric.Canvas('my-canvas', {
                width: 1080,
                height: 1080,
                backgroundColor: '#fcfcfc',
                selection: true,
                controlsAboveOverlay: true
            });

           // fabric.Object.ownProperties.push('name', 'isButton', 'isButtonText', 'isButtonRect');
            
            // --- Constants ---
            let CANVAS_WIDTH = 1080;
            let CANVAS_HEIGHT = 1080;
            const FONT_OPTIONS = ['Inter', 'Roboto', 'Poppins', 'Arial', 'Verdana', 'Georgia'];
            let currentZoom = 0.64; // Default zoom
           // let logoObject = null; // Used by initial template

            let loadedTemplateGroupId = null;
            let currentTemplateVariants = null;
            
            // --- Get all the HTML elements ---
            const bgColorPicker = document.getElementById('bg-color-picker');
            const addImageInput = document.getElementById('add-image-input');
            const deleteBtn = document.getElementById('delete-btn');
            const exportPngBtn = document.getElementById('export-png-btn');
            
            const textControls = document.getElementById('text-controls');
            const fontFamilySelect = document.getElementById('font-family-select');
            const fontSizeInput = document.getElementById('font-size-input');
            const textColorPicker = document.getElementById('text-color-picker');
            
            const buttonControls = document.getElementById('button-controls');
            const buttonColorPicker = document.getElementById('button-color-picker');
            
            const addTitleBtn = document.getElementById('add-title-btn');
            const addSubtitleBtn = document.getElementById('add-subtitle-btn');
            const addButtonBtn = document.getElementById('add-button-btn');
            
            const imageUrlInput = document.getElementById('image-url-input');
            const addImageUrlBtn = document.getElementById('add-image-url-btn');

            const exportTemplateBtn = document.getElementById('export-template-btn');
            const importTemplateBtn = document.getElementById('import-template-btn');
            const templateFileInput = document.getElementById('templateFileInput');
            
            const moveToFrontBtn = document.getElementById('move-to-front-btn');
            const sendToBackBtn = document.getElementById('send-to-back-btn');
            const moveForwardBtn = document.getElementById('move-forward-btn');
            const sendBackwardBtn = document.getElementById('send-backward-btn');

            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomResetBtn = document.getElementById('zoom-reset');

            // ADD THESE TWO LINES
            const lockSelectedBtn = document.getElementById('lock-selected-btn');
            const unlockAllBtn = document.getElementById('unlock-all-btn');


            // --- NEW Zoom Logic (from File 2) ---
            function updateZoom(zoomLevel) {
                currentZoom = parseInt(zoomLevel) / 100;
                if (zoomValue) zoomValue.textContent = Math.round(currentZoom * 100) + '%';
                const canvasContainer = document.getElementById('canvas-container');
                if (canvasContainer) {
                    canvasContainer.style.transform = `scale(${currentZoom})`;
                }
                canvas.renderAll();
            }
            
            function zoomIn() {
                let newZoom = Math.min(currentZoom * 100 + 25, 200);
                zoomSlider.value = newZoom;
                updateZoom(newZoom);
            }
            
            function zoomOut() {
                let newZoom = Math.max(currentZoom * 100 - 25, 25);
                zoomSlider.value = newZoom;
                updateZoom(newZoom);
            }
            
            function resetZoom() {
                zoomSlider.value = 64; // Reset to default
                updateZoom(64);
            }
            
            // --- Contextual Controls Logic (from File 2) ---
            
            function onSelectionChanged() {
                const activeObject = canvas.getActiveObject();
                
                // Hide all controls first
                textControls.classList.add('hidden');
                buttonControls.classList.add('hidden');

                if (!activeObject) return;

                let targetTextObject = null;
                let isButton = activeObject.isButton;

                if (isButton) {
                    targetTextObject = activeObject.text; 
                } else if (activeObject instanceof fabric.IText || activeObject instanceof fabric.Textbox) {
                    targetTextObject = activeObject;
                }

                // Show Text Controls
                if (targetTextObject) {
                    textControls.classList.remove('hidden');
                    fontSizeInput.value = targetTextObject.fontSize;
                    fontFamilySelect.value = targetTextObject.fontFamily;
                    textColorPicker.value = targetTextObject.fill;
                } 
                
                // Show Button Controls
                if (isButton) {
                    buttonControls.classList.remove('hidden');
                    const buttonRect = activeObject.rect;
                    if (buttonRect) {
                        buttonColorPicker.value = buttonRect.fill;
                    }
                }
            }

            function updateTextStyle(property, value) {
                let activeObject = canvas.getActiveObject();
                if (!activeObject) return;
                
                let targetObject = activeObject.isButton ? activeObject.text : activeObject;

                if (targetObject instanceof fabric.IText || targetObject instanceof fabric.Textbox) {
                    if (property === 'fontSize') {
                        value = parseInt(value);
                        if (isNaN(value) || value < 10) value = 10;
                    }
                    
                    targetObject.set(property, value);
                    
                    if (targetObject.isButtonText) {
                        targetObject.fire('changed'); // Custom event for button resizing
                    }

                    canvas.renderAll();
                }
            }

            function updateButtonColor(color) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.isButton) {
                    activeObject.rect.set('fill', color);
                    canvas.renderAll();
                }
            }

            
            // --- Add Element Functions (from File 2) ---
            
            function createButton(text, left, top, color = '#fcd34d') {
                const rectPadding = 60;
                const rectHeightPadding = 30;

                const buttonText = new fabric.IText(text, {
                    fontSize: 40,
                    fill: '#1f2937', 
                    fontWeight: 'bold',
                    originX: 'center',
                    originY: 'center',
                    hasControls: false,
                    editable: true,
                    fontFamily: 'Inter',
                });
                buttonText.isButtonText = true;

                let rectWidth = buttonText.width + rectPadding;
                let rectHeight = buttonText.height + rectHeightPadding;

                const buttonRect = new fabric.Rect({
                    fill: color, width: rectWidth, height: rectHeight,
                    rx: 15, ry: 15, originX: 'center', originY: 'center',
                });
                buttonRect.isButtonRect = true;

                const actionButton = new fabric.Group([buttonRect, buttonText], {
                    left: left, top: top, originX: 'center', originY: 'center',
                    name: 'actionButton', isButton: true, subTargetCheck: true,
                    rect: buttonRect, text: buttonText,
                });
                
                const resizeButtonRect = function() {
                    const newWidth = Math.max(buttonText.width * buttonText.scaleX + rectPadding, 100);
                    const newHeight = Math.max(buttonText.height * buttonText.scaleY + rectHeightPadding, 50);

                    buttonRect.set({
                        width: newWidth / buttonRect.scaleX, 
                        height: newHeight / buttonRect.scaleY,
                    });

                    actionButton._calcBounds(true);
                    canvas.requestRenderAll();
                }

                buttonText.on('changed', resizeButtonRect);
                actionButton.on('scaling', resizeButtonRect);
                return actionButton;
            }

            function addTitleText() {
                const title = new fabric.Textbox('New Gospel Message', {
                    left: CANVAS_WIDTH / 2, top: CANVAS_HEIGHT / 4,
                    width: CANVAS_WIDTH * 0.8, fontSize: 85, fontWeight: '900',
                    fill: '#6d28d9', textAlign: 'center', originX: 'center',
                    originY: 'center', fontFamily: 'Inter', name: 'title_' + Date.now()
                });
                canvas.add(title);
                canvas.setActiveObject(title);
                canvas.renderAll();
                onSelectionChanged();
            }

            function addSubtitleText() {
                const subtitle = new fabric.Textbox('A New Testament truth for today.', {
                    left: CANVAS_WIDTH / 2, top: CANVAS_HEIGHT / 2,
                    width: CANVAS_WIDTH * 0.75, fontSize: 38, fill: '#4b5563',
                    textAlign: 'center', originX: 'center', originY: 'center',
                    fontFamily: 'Inter', name: 'subtitle_' + Date.now()
                });
                canvas.add(subtitle);
                canvas.setActiveObject(subtitle);
                canvas.renderAll();
                onSelectionChanged();
            }

            function addActionButton() {
                const actionButton = createButton('FIND OUT MORE', CANVAS_WIDTH / 2, CANVAS_HEIGHT * 0.75, '#fcd34d');
                actionButton.name = 'actionButton_' + Date.now();
                actionButton.text.set('fill', '#1f2937');
                canvas.add(actionButton);
                canvas.setActiveObject(actionButton);
                canvas.renderAll();
                onSelectionChanged();
            }
            
            /**
             * Loads the initial Gospel template elements.
             */
            function addInitialElements() {
                // // 1. Logo (Image)
                // const initialLogoUrl = 'https://placehold.co/150x150/6d28d9/ffffff?text=MINISTRY';
                // fabric.Image.fromURL(initialLogoUrl, function(img) {
                //     logoObject = img;
                //     logoObject.set({
                //         left: 90, top: 90,
                //         scaleX: 150 / img.width, scaleY: 150 / img.height,
                //         lockUniScaling: true, name: 'logo',
                //         clipPath: new fabric.Circle({ 
                //             radius: 75, left: -75, top: -75,
                //         })
                //     });
                //     canvas.add(logoObject);
                //     canvas.renderAll();
                // }, { crossOrigin: 'anonymous' });

                // 2. Title Text
                const title = new fabric.Textbox('Find Hope, Joy, & New Life', {
                    left: CANVAS_WIDTH / 2, top: 350, width: CANVAS_WIDTH * 0.8,
                    fontSize: 85, fontWeight: '900', fill: '#6d28d9',
                    textAlign: 'center', originX: 'center', originY: 'center',
                    fontFamily: 'Inter', name: 'title'
                });
                canvas.add(title);

                // 3. Subtitle Text
                const subtitle = new fabric.Textbox('Join us for Worship or Stream the Sunday Message.', {
                    left: CANVAS_WIDTH / 2, top: 550, width: CANVAS_WIDTH * 0.75,
                    fontSize: 38, fill: '#4b5563', textAlign: 'center',
                    originX: 'center', originY: 'center', fontFamily: 'Inter', name: 'subtitle'
                });
                canvas.add(subtitle);

                // 4. Action Button
                const actionButton = createButton('WATCH LIVE NOW', CANVAS_WIDTH / 2, 800, '#fcd34d');
                actionButton.text.set('fill', '#1f2937');
                canvas.add(actionButton);

                canvas.renderAll();
            }
            

            // --- Basic Toolbar Functions (from File 1, modified) ---

            // Background Color
            bgColorPicker.addEventListener('input', (e) => {
                canvas.backgroundColor = e.target.value;
                canvas.renderAll();
            });

            // Add Image from File (UPDATED)
            addImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (f) => {
                    const data = f.target.result;
                    fabric.Image.fromURL(data, (img) => {
                        
                        const canvasWidth = canvas.getWidth();
                        const canvasHeight = canvas.getHeight();
                        const scale = Math.max(canvasWidth / img.width, canvasHeight / img.height);
                        
                        img.set({
                            left: canvasWidth / 2,
                            top: canvasHeight / 2,
                            originX: 'center',
                            originY: 'center',
                            scaleX: scale,
                            scaleY: scale,
                            selectable: true, 
                            evented: true
                        });
                        
                        canvas.add(img);
                        img.sendToBack(); 
                        canvas.discardActiveObject();
                        canvas.renderAll();
                    });
                };
                reader.readAsDataURL(file);
                e.target.value = null; // Clear input
            });
            
            // Add Image from URL (UPDATED)
            function addImageFromUrl() {
                const url = imageUrlInput.value;
                if (!url) {
                    alert('Please paste an image URL');
                    return;
                }
                
                fabric.Image.fromURL(url, function(img) {
                    
                    const canvasWidth = canvas.getWidth();
                    const canvasHeight = canvas.getHeight();
                    const scale = Math.max(canvasWidth / img.width, canvasHeight / img.height);

                    img.set({
                        left: canvasWidth / 2,
                        top: canvasHeight / 2,
                        originX: 'center',
                        originY: 'center',
                        scaleX: scale,
                        scaleY: scale,
                        selectable: true, 
                        evented: true
                    });
                    
                    canvas.add(img);
                    img.sendToBack(); 
                    canvas.discardActiveObject(); 
                    canvas.renderAll();
                    imageUrlInput.value = ''; // Clear input
                }, { crossOrigin: 'anonymous', onerror: (err) => {
                    console.error("Failed to load image:", err);
                    alert('Failed to load image. Make sure it is a valid URL and CORS is enabled.');
                }});
            }

            // Delete Selected
            deleteBtn.addEventListener('click', () => {
                canvas.getActiveObjects().forEach((obj) => {
                    canvas.remove(obj);
                });
                canvas.discardActiveObject().renderAll();
            });
            
            // Export as PNG (MODIFIED FOR BATCH EXPORT)
                    // WITH THIS: (Always call single export based on the current canvas state)
            exportPngBtn.addEventListener('click', singleExportPng);

            // NEW: Single Export Function (Existing logic moved here)
            function singleExportPng() {
                try {
                    // ... (keep the original single export logic here) ...
                    canvas.discardActiveObject();
                    canvas.renderAll();
                    
                    const dataURL = canvas.toDataURL({
                        format: 'png',
                        quality: 1.0,
                        multiplier: 1
                    });
                    const link = document.createElement('a');
                    link.href = dataURL;
                    
                    const safeWidth = canvas.getWidth() || 1080;
                    const safeHeight = canvas.getHeight() || 1080;
                    link.download = `my-ad-design-${safeWidth}x${safeHeight}.png`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert(`Single export finished: ${link.download}`);

                } catch (err) {
                    console.error('Export failed:', err);
                    alert('Export failed.');
                }
            }
            
            // NEW: Batch Export Function (Must be async)
            async function batchExportGroup(groupId) { 
                const group = window.TEMPLATES_DB[groupId];
                if (!group || !group.variants) {
                    alert('Could not find template group for batch export.');
                    return;
                }
                
                let exportCount = 0;
                const variantIds = Object.keys(group.variants);
                
                // Disable the export button to prevent multiple clicks
                exportPngBtn.disabled = true;
                exportPngBtn.textContent = `Exporting (0/${variantIds.length})...`;
                
                // Use a loop that waits for each load to complete
                for (let i = 0; i < variantIds.length; i++) {
                    const variantId = variantIds[i];
                    const variant = group.variants[variantId];

                    try {
                        // AWAIT the template to fully load and render (Images included)
                        await loadTemplate(variant);
                        
                        // Update UI feedback
                        exportPngBtn.textContent = `Exporting (${i + 1}/${variantIds.length})...`;

                        // Canvas is guaranteed to be ready here
                        canvas.discardActiveObject();
                        canvas.renderAll();

                        const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0 });
                        const link = document.createElement('a');
                        link.href = dataURL;
                        
                        const safeWidth = canvas.getWidth() || 1080;
                        const safeHeight = canvas.getHeight() || 1080;
                        const templateName = variant.name.replace(/\s+/g, '_');
                        
                        link.download = `${templateName}-${safeWidth}x${safeHeight}.png`;
                        
                        // Trigger download
                        link.click(); 
                        
                        exportCount++;

                    } catch (e) {
                        console.error(`Export failed for variant ${variant.name}:`, e);
                    }
                }
                
                // Re-enable the button and alert success
                exportPngBtn.disabled = false;
                exportPngBtn.textContent = 'Export as PNG';
                alert(`Batch export finished! Exported ${exportCount} variant(s) from the '${group.name}' group.`);
            }


            // --- Template Functions (from File 2) ---

            function exportTemplate() {
                const templateName = prompt("Enter a name for this template:", "My Gospel Template");
                if (!templateName) return;
                
                // Save custom properties
                const canvasData = canvas.toObject(['name', 'isButton', 'isButtonText', 'isButtonRect']);
                
                const template = {
                    name: templateName,
                    // NEW: Save dimensions with the template
                    dimensions: `${canvas.getWidth()}x${canvas.getHeight()}`, 
                    data: {
                        version: "5.3.0",
                        backgroundColor: canvas.backgroundColor,
                        objects: canvasData.objects
                    }
                };
                
                const templateJSON = JSON.stringify(template, null, 2);
                const blob = new Blob([templateJSON], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${templateName.replace(/\s+/g, '_').toLowerCase()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert(`Template "${templateName}" exported!`);
            }
            
            function importTemplate() {
                templateFileInput.click();
            }
            
            templateFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const template = JSON.parse(event.target.result);
                        // NEW: Pass the *whole* template object
                        loadTemplate(template);
                    } catch (error) {
                        console.error("Error parsing template:", error);
                        alert("Error loading template: Invalid file.");
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
       // ü•á CRITICAL FIX: LoadTemplate must be PROMISE-BASED to work with AWAIT
        function loadTemplate(template) {
            return new Promise((resolve, reject) => { // <-- NEW: RETURN PROMISE
                if (!template || !template.data) {
                    if (template.objects) {
                        template = { data: template, name: 'Imported' };
                    } else {
                        reject(new Error("Invalid template format.")); 
                        return;
                    }
                }
                
                // 1. Manually Pre-process Data (Added crossOrigin fix)
                function preprocessObjects(objects) {
                    objects.forEach(obj => {
                        if (obj.type === 'image' && obj.src && obj.src.startsWith('http')) {
                            obj.crossOrigin = 'anonymous'; // CRITICAL for non-tainted export
                        }
                        if (obj.objects) {
                            preprocessObjects(obj.objects);
                        }
                    });
                }
    
                if (template.data && template.data.objects) {
                    preprocessObjects(template.data.objects);
                }
                
                // 2. Handle Resizing (Your existing logic)
                if (template.dimensions) {
                    const dims = template.dimensions.split('x');
                    const newWidth = parseInt(dims[0], 10);
                    const newHeight = parseInt(dims[1], 10);
                    
                    if (newWidth && newHeight) {
                        CANVAS_WIDTH = newWidth;
                        CANVAS_HEIGHT = newHeight;
                        
                        const canvasContainer = document.getElementById('canvas-container');
                        if (canvasContainer) {
                            const maxWidth = 800;
                            const maxHeight = 800;
                            const aspectRatio = newWidth / newHeight;
                            let displayWidth = maxWidth;
                            let displayHeight = displayWidth / aspectRatio;
                            if (displayHeight > maxHeight) {
                                displayHeight = maxHeight;
                                displayWidth = displayHeight * aspectRatio;
                            }
                            canvasContainer.style.width = displayWidth + 'px';
                            canvasContainer.style.height = displayHeight + 'px';
                        }
                        
                        canvas.setWidth(newWidth);
                        canvas.setHeight(newHeight);
                    }
                }
                
               // 4. Load Objects using the stable loadFromJSON (asynchronous)
                canvas.loadFromJSON(template.data, function() {
                    
                    // Re-establish custom button properties after loading from JSON
                    canvas.getObjects().forEach(obj => {
                        // Check if it's a group and if it has at least 2 items (rect and i-text)
                        if (obj.type === 'group' && obj.item(0) && obj.item(1)) {
                            
                            const item0 = obj.item(0);
                            const item1 = obj.item(1);

                            if (item0.type === 'rect' && item1.type === 'i-text') {
                                // Re-establish required runtime properties for controls to work
                                obj.isButton = true;
                                obj.rect = item0; 
                                obj.text = item1; 
                                obj.text.isButtonText = true; 
                                // Also ensure the children have their event listeners reactivated
                                item1.on('changed', obj._onObjectChange);
                                obj.on('scaling', obj._onObjectChange);
                            }
                        }
                    });

                    // Finalize rendering
                    canvas.calcOffset(); 
                    canvas.renderAll();
                    canvas.discardActiveObject();
                    
                    resolve(); // <-- CRITICAL: RESOLVE the Promise here
                });
            });
        }

            // --- NEW Layer Control Functions ---
            function moveLayer(direction) {
                const obj = canvas.getActiveObject();
                if (!obj) return;
                
                switch(direction) {
                    case 'front':
                        obj.bringToFront();
                        break;
                    case 'back':
                        obj.sendToBack();
                        break;
                    case 'forward':
                        obj.bringForward();
                        break;
                    case 'backward':
                        obj.sendBackwards();
                        break;
                }
                canvas.renderAll();
            }

function populateVariantsSidebar(groupId, variants) {
    const variantsList = document.getElementById('variants-list');
    const variantsPlaceholder = document.getElementById('variants-placeholder');
    
    if (variantsPlaceholder) variantsPlaceholder.remove();
    
    // Clear existing buttons
    variantsList.innerHTML = '';
    
    for (const variantId in variants) {
        if (variants.hasOwnProperty(variantId)) {
            const variantData = variants[variantId];
            
            // Container for the variant controls
            const container = document.createElement('div');
            container.className = 'p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm space-y-2';

            const nameText = document.createElement('p');
            nameText.className = 'font-semibold text-gray-700 text-sm';
            nameText.textContent = `${variantData.name} (${variantData.dimensions})`;
            container.appendChild(nameText);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex gap-2';
            
            // 1. Load Button
            const loadButton = document.createElement('button');
            loadButton.className = 'flex-1 text-xs bg-blue-500 text-white py-1 px-2 rounded-md hover:bg-blue-600 transition';
            loadButton.textContent = 'üé® Load';
            loadButton.addEventListener('click', async () => {
                await loadTemplate(variantData);

                                            const maxVisualWidth = 800; 
                            const maxVisualHeight = 800; 
                            
                            const fitRatioX = maxVisualWidth / CANVAS_WIDTH;
                            const fitRatioY = maxVisualHeight / CANVAS_HEIGHT;
                            
                            // Use the minimum ratio to ensure it fits entirely (no cropping)
                            const fitRatio = Math.min(fitRatioX, fitRatioY);
                            
                            const fitZoom = fitRatio * 100;

                            populateVariantsSidebar(loadedTemplateGroupId, currentTemplateVariants);
                            // Use the calculated zoom
                            updateZoom(Math.min(fitZoom, 100));
            });

            // 2. Export Button (Single-Click Export from Sidebar)
            const exportVariantButton = document.createElement('button');
            exportVariantButton.className = 'flex-1 text-xs bg-green-500 text-white py-1 px-2 rounded-md hover:bg-green-600 transition';
            exportVariantButton.textContent = 'üíæ Export';
            
            // This button loads the variant, then immediately exports it, fulfilling the one-by-one export request.
            exportVariantButton.addEventListener('click', async () => {
                // Temporarily disable buttons to prevent rapid clicks
                exportVariantButton.disabled = true;
                exportVariantButton.textContent = 'Exporting...';

                try {
                    // Load the template asynchronously (must wait)
                    await loadTemplate(variantData);
                    
                    // Call the single export logic immediately after loading
                    singleExportPng(); 
                    alert(`Exported: ${variantData.name} (${variantData.dimensions})`);

                } catch (e) {
                    console.error('Export Failed:', e);
                    alert(`Failed to export ${variantData.name}.`);
                } finally {
                    exportVariantButton.disabled = false;
                    exportVariantButton.textContent = 'üíæ Export';
                    // Re-render the canvas to show the loaded state after export
                    canvas.renderAll(); 
                }
            });

            buttonGroup.appendChild(loadButton);
            buttonGroup.appendChild(exportVariantButton);
            container.appendChild(buttonGroup);
            variantsList.appendChild(container);
        }
    }
}

            // --- 2. START OF CORRECTED FINAL BLOCK ---
            
            // Populate Font Dropdown
            FONT_OPTIONS.forEach(font => {
                const option = document.createElement('option');
                option.value = font;
                option.textContent = font;
                fontFamilySelect.appendChild(option);
            });
            
            // Contextual control listeners
            fontFamilySelect.addEventListener('change', (e) => updateTextStyle('fontFamily', e.target.value));
            fontSizeInput.addEventListener('input', (e) => updateTextStyle('fontSize', e.target.value));
            textColorPicker.addEventListener('input', (e) => updateTextStyle('fill', e.target.value));
            buttonColorPicker.addEventListener('input', (e) => updateButtonColor(e.target.value));

            // Canvas selection listeners
            canvas.on('selection:created', onSelectionChanged);
            canvas.on('selection:updated', onSelectionChanged);
            canvas.on('selection:cleared', onSelectionChanged);

            // Double-click to edit text
            canvas.on('mouse:dblclick', function(options) {
                if (!options.target) return;
                let targetObject = options.target.isButton ? options.target.text : options.target;
                if (targetObject instanceof fabric.IText || targetObject instanceof fabric.Textbox) {
                    canvas.setActiveObject(targetObject);
                    targetObject.enterEditing();
                    canvas.renderAll();
                }
            });
            
            // Add element listeners
            addTitleBtn.addEventListener('click', addTitleText);
            addSubtitleBtn.addEventListener('click', addSubtitleText);
            addButtonBtn.addEventListener('click', addActionButton);
            addImageUrlBtn.addEventListener('click', addImageFromUrl);
            
            // Template listeners
            exportTemplateBtn.addEventListener('click', exportTemplate);
            importTemplateBtn.addEventListener('click', importTemplate);
            
            // Layer listeners
            moveToFrontBtn.addEventListener('click', () => moveLayer('front'));
            sendToBackBtn.addEventListener('click', () => moveLayer('back'));
            moveForwardBtn.addEventListener('click', () => moveLayer('forward'));
            sendBackwardBtn.addEventListener('click', () => moveLayer('backward'));
            
            // Zoom listeners (Only one block)
            zoomSlider.addEventListener('input', (e) => updateZoom(e.target.value));
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            zoomResetBtn.addEventListener('click', resetZoom);

            // --- NEW Lock Control Listeners ---
            lockSelectedBtn.addEventListener('click', () => {
                const obj = canvas.getActiveObject();
                if (obj) {
                    obj.set({
                        selectable: false,
                        evented: false, 
                    });
                    canvas.discardActiveObject(); 
                    canvas.renderAll();
                    console.log('Object locked');
                }
            });

            unlockAllBtn.addEventListener('click', () => {
                canvas.getObjects().forEach(obj => {
                    obj.set({
                        selectable: true,
                        evented: true,
                    });
                });
                canvas.renderAll();
                console.log('All objects unlocked');
            });

           // --- NEW: Load Initial State (MODIFIED) ---
            (function autoLoadFromQuery() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const tid = params.get('templateId');
                    
                    // Note: No fabric.Object.ownProperties.push line here, as it broke things.

                    if (!tid) {
                        addInitialElements(); 
                        updateZoom(64);
                        return;
                    }

                    let templateVariant = null;
                    const db = window.TEMPLATES_DB || window.TEMPLATES; 
                    
                    if (db) {
                        for (const groupId in db) {
                            const group = db[groupId];
                            if (group.variants && group.variants[tid]) {
                                templateVariant = group.variants[tid]; 
                                // **CRITICAL: Save Group ID and Variants**
                                loadedTemplateGroupId = groupId;
                                currentTemplateVariants = group.variants;
                                break; 
                            }
                        }
                    }

                    if (templateVariant) {
                        const dims = templateVariant.dimensions.split('x');
                        const newWidth = parseInt(dims[0], 10);
                        const newHeight = parseInt(dims[1], 10);

                        if (!newWidth || !newHeight) {
                             console.error('Invalid template dimensions:', templateVariant.dimensions);
                             addInitialElements(); 
                             updateZoom(64);
                             return;
                        }

                        // Set canvas dimensions
                        CANVAS_WIDTH = newWidth;
                        CANVAS_HEIGHT = newHeight;
                        
                        // Load the template (The AWAIT waits for the promise resolve in loadFromJSON)
                        loadTemplate(templateVariant).then(() => {
                            // After loading, populate the right sidebar

                            const maxVisualWidth = 800; 
                            const maxVisualHeight = 800; 
                            
                            const fitRatioX = maxVisualWidth / CANVAS_WIDTH;
                            const fitRatioY = maxVisualHeight / CANVAS_HEIGHT;
                            
                            // Use the minimum ratio to ensure it fits entirely (no cropping)
                            const fitRatio = Math.min(fitRatioX, fitRatioY);
                            
                            const fitZoom = fitRatio * 100;

                            populateVariantsSidebar(loadedTemplateGroupId, currentTemplateVariants);
                            // Use the calculated zoom
                            updateZoom(Math.min(fitZoom, 100));
                        }).catch(err => {
                             console.error('Error loading template:', err);
                             addInitialElements(); 
                             updateZoom(64);
                        });

                        return;

                    } else {
                        console.warn('Could not find template data for ID:', tid);
                        // If template not found, do not load default, just update zoom
                        updateZoom(64);
                    }
                } catch (err) {
                    console.warn('Failed to auto-load template from query:', err);
                    addInitialElements(); 
                    updateZoom(64);
                }
            })();
            // --- END OF CORRECTED FINAL BLOCK ---

        });
    </script>
</body>
</html>